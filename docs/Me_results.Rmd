---
title: Effect of modelling $V_{Me}$ only on estimating $V_{A}$
author: "Joel Pick"
output: html_document
---



```{r, echo=FALSE, message=FALSE}
rm(list=ls())

library(viridis)

wd <- "/Users/joelpick/github/maternal_effects/"
data_wd <- paste0(wd,"Data/Intermediate/")

source(paste0(wd,"R/00_functions.R"))
# load(paste0(data_wd,"gaussian_data.Rdata"))
load(paste0(data_wd,"gaussian_sims.Rdata"))

comp_names <- c("A","Me","Mg","cov_AMg","E")
model_names <- c(
	"A",
	"A + Me",
	"A + Mg",
  "A + Mg + Me",
  "A + Mg + cov + Me",
  "Mg",
  "Mg + Me",
  "Mg average"
	)

scenarios2 <- scenarios[,c(1,4,2,3)]
scenarios2[,"r_amg"] <- scenarios2[,"r_amg"]*sqrt(scenarios2[,"Va"])*sqrt(scenarios2[,"Vmg"])
scenarios2 <- cbind(scenarios2,1 - rowSums(scenarios2) - scenarios2[,"r_amg"])
colnames(scenarios2) <- c("A","Me","Mg","cov_AMg","E")


model5_fs <- lapply(model5_fs, function(x){
  x[x=="Error in asreml(fixed = p ~ 1, random = ~str(~vm(animal, ped.ainv) + vm(mother,  : \n  Variance structure is not positive definite\n"]<-NA
	matrix(as.numeric(x),nrow=nrow(x),ncol=ncol(x))
})
model5_hs <- lapply(model5_hs, function(x){
  x[x=="Error in asreml(fixed = p ~ 1, random = ~str(~vm(animal, ped.ainv) + vm(mother,  : \n  Variance structure is not positive definite\n"]<-NA
	matrix(as.numeric(x),nrow=nrow(x),ncol=ncol(x))
})
## some the covariance models are systematically not working well for only some scenarios ?!
# table(c(sapply(model5_fs, function(x) which(apply(x,1,function(i) all(is.na(i))))),recursive=TRUE))
# table(c(sapply(model5_hs, function(x) which(apply(x,1,function(i) all(is.na(i))))),recursive=TRUE))

## summaries for all the models
for(i in 1:8){
	for(j in c("fs","hs")){
		dat <- get(paste0("model",i,"_",j))
		assign(paste0("m",i,"_",j),apply(list2array(dat), c(1,2), mean, na.rm=TRUE))
	}
}

for(i in 1:2){
	for(j in c("fhs","fhs10")){
		dat <- get(paste0("model",i,"_",j))
		assign(paste0("m",i,"_",j),apply(list2array(dat), c(1,2), mean, na.rm=TRUE))
	}
}

load(paste0(data_wd,"real_sims.Rdata"))

for(i in 1:2){
	for(j in c("bt_socialD","bt_social","bt","rd","ss")){
		dat <- get(paste0("model",i,"_",j))
		assign(paste0("m",i,"_",j),apply(list2array(dat), c(1,2), mean, na.rm=TRUE))
	}
}

```


# First Sims

```{r, 'first-sims',fig.width=10, fig.height=5, echo=FALSE}

{

cols <- inferno(6)[2:6]
order <- c(4,1,3,2,5)
	all_mod<-lapply(c(1,2,4,3,5,6,9,7,8,10,11), function(i){
		rbind(
			scenarios2[i,order],
			m1_fs[i,order],m1_hs[i,order],
			m2_fs[i,order],m2_hs[i,order]
		)	
	})

	layout(matrix(c(1,2,3,12,4:11),byrow=TRUE,ncol=4))
	par(mar=c(3,4,1,1))
	for(i in 1:11){
		bp<-barplot(t(change2zero(all_mod[[i]])),space=c(0,1,0,0.3,0), col=cols, ylim=c(-0.1,1.2))
		axis(1,bp,c("sim",rep(c("fs","hs"),2)))
	}
	

	plot(NULL,xaxt="n",yaxt="n",ylim=c(-1,1),xlim=c(-1,1), bty="n", ylab="", xlab="")
	legend("left", comp_names[order], pch=19, col=cols, bty="n")
	legend("right", model_names, pch=as.character(1:8), bty="n")
}


```



# Real pedigrees

```{r, 'real-data', fig.width=10, fig.height=5, echo=FALSE}

{

	all_mod<-lapply(c(1,2,4,3,5,6,9,7,8,10,11), function(i){
		rbind(
			scenarios2[i,order],
			m1_fs[i,order],m1_hs[i,order],m1_bt_social[i,order],m1_bt[i,order],m1_rd[i,order],m1_ss[i,order],
			m2_fs[i,order],m2_hs[i,order],m2_bt_social[i,order],m2_bt[i,order],m2_rd[i,order],m2_ss[i,order]
		)	
	})

	layout(matrix(c(1,2,3,12,4:11),byrow=TRUE,ncol=4))
	par(mar=c(3,4,1,1))
	for(i in 1:11){
		bp<-barplot(t(change2zero(all_mod[[i]])),space=c(0,1,0,0.3,0,0,0,0.5,0,0.3,0,0,0), col=cols, ylim=c(-0.1,1.2))
		axis(1,bp,c("sim",rep(c("fs","hs","btS","bt","rd","ss"),2)))
	}
	

	plot(NULL,xaxt="n",yaxt="n",ylim=c(-1,1),xlim=c(-1,1), bty="n", ylab="", xlab="")
	legend("left", comp_names[order], pch=19, col=cols, bty="n")
	legend("right", model_names, pch=as.character(1:8), bty="n")
}


```


# More sims
```{r, 'more-sims', fig.width=10, fig.height=5, echo=FALSE}


{

	all_mod<-lapply(c(1,2,4,3,5,6,9,7,8,10,11), function(i){
		rbind(
			scenarios2[i,order],
			m1_fs[i,order],m1_hs[i,order],m1_fhs[i,order],m1_fhs10[i,order],
			m2_fs[i,order],m2_hs[i,order],m2_fhs[i,order],m2_fhs10[i,order]
		)	
	})

	layout(matrix(c(1,2,3,12,4:11),byrow=TRUE,ncol=4))
	par(mar=c(3,4,1,1))
	for(i in 1:11){
		bp<-barplot(t(change2zero(all_mod[[i]])),space=c(0,1,0,0,0,0.3,0,0,0), col=cols, ylim=c(-0.1,1.2))
		axis(1,bp,c("sim",rep(c("fs","hs","fhs","fhs10"),2)))
	}
	

	plot(NULL,xaxt="n",yaxt="n",ylim=c(-1,1),xlim=c(-1,1), bty="n", ylab="", xlab="")
	legend("left", comp_names[order], pch=19, col=cols, bty="n")
	legend("right", model_names, pch=as.character(1:8), bty="n")
}



```


Notes from meeting

- focus on V_Me models 
- impact on V_a in BT pedigree versus deer and sheep - immigration? see Kruuk and Hadfield
- how covariances affect it with different pedigrees
- this might also affect the maternal effect estimation? check

- calculate things like coverage/false error rate etc

- implications for evolutionary potential

- evolutionary potential from Va AND Vmg, make inferences based on VA, but can make confidence intervals that range from bottom of Va to top of Va + 0.5Vmg 
 - need to work out what happens with covariance


