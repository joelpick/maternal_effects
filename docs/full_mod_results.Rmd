


```{r, echo=FALSE, cache=TRUE}

## load in data

rm(list=ls())

wd <- "/Users/joelpick/github/maternal_effects/"

data_wd <- paste0(wd,"Data/Intermediate/")

source(paste0(wd,"R/00_functions.R"))
load(paste0(data_wd,"parameters.Rdata"))
load(paste0(data_wd,"mge_sims_small_ped.Rdata"))

library(beeswarm)
library(scales)


order_exp <- expand.grid(fec=c("lF"),ms=c("fhs"), model=c(1,2,4,5),imm=c("mI","nI","bI","fI"),size=c("small","medium"))
order<-apply(order_exp,1,function(x) paste(x[c(2,1,4,5,3)],collapse="_"))

mod1<-do.call(rbind,lapply(ped_names_reduced,function(k) {
	mod1 <- do.call(rbind,lapply(get(paste0("model1_",k)), function(x) {
			data.frame(
				r=k,
				scenario=1:nrow(scenarios),
				Va_est = x[["ml"]][,"A"],
				Va_sim=scenarios[,"Va"])
	}))
}))

mod2<-do.call(rbind,lapply(ped_names_reduced,function(k) {
	mod2 <- do.call(rbind,lapply(get(paste0("model2_",k)), function(x) {
			data.frame(
				r=k,
				scenario=1:nrow(scenarios),
				Va_est = x[["ml"]][,"A"],
				Va_sim=scenarios[,"Va"])
	}))
}))

mod4<-do.call(rbind,lapply(ped_names_reduced,function(k) {
	mod4 <- do.call(rbind,lapply(get(paste0("model4_",k)), function(x) {
			data.frame(
				r=k,
				scenario=1:nrow(scenarios),
				Va_est = x[["ml"]][,"A"],
				Va_sim=scenarios[,"Va"])
	}))
}))

mod5<-do.call(rbind,lapply(ped_names_reduced,function(k) {
	mod5 <- do.call(rbind,lapply(get(paste0("model5_",k)), function(x) {
			data.frame(
				r=k,
				scenario=1:nrow(scenarios),
				Va_est = x[["ml"]][,"A"],
				Va_sim=scenarios[,"Va"])
	}))
}))



all_mod<-rbind(
	cbind(model=1,mod1),
	cbind(model=2,mod2),
	cbind(model=4,mod4),	
	cbind(model=5,mod5)
)
all_mod$r_model <- paste0(all_mod$r,"_",all_mod$model)
all_mod$order <- match(all_mod$r_model,order)

all_mod$Va_bias <- all_mod$Va_est - all_mod$Va_sim


va<- aggregate(Va_est ~ scenario+r_model+r+model, all_mod,mean)

va$Va_sd<- aggregate(Va_est ~ scenario+r_model+r+model, all_mod,sd)$Va_est
va$Va_precision<- aggregate(Va_est ~ scenario+r_model+r+model, all_mod,function(x)1/sd(x))$Va_est
va$Va_rel_prec<-va$Va_est/va$Va_sd

va$Va_bias <- aggregate(Va_bias ~ scenario+r_model+r+model, all_mod, function(x) mean(x))$Va_bias

va$Va_abs_bias <- aggregate(Va_bias ~ scenario+r_model+r+model, all_mod, function(x) mean(abs(x)))$Va_bias

va$order <- match(va$r_model,order)


va$Va_z<-va$Va_sd/va$Va_est


```


# Scenarios
```{r, echo=FALSE}
knitr::kable(scenarios)
```


# Pedigrees
```{r, echo=FALSE}
knitr::kable(peds_param_reduced)
```


# Models

Run 4 models

Model 1: $$p_i = a_i + \epsilon_i$$

Model 2: $$p_i = a_i + m_{I,j} + \epsilon_i$$

Model 3: $$p_i = a_i + m_{G,j} + m_{E,j} + \epsilon_i$$

Model 4: $$p_i = a_i + m_{G,j} + m_{E,j} + \epsilon_i$$
$$[a_i,m_{G,i}] \sim N(0, \begin{bmatrix}
\sigma^2_{A} & \sigma_{A,Mg}  \\
\sigma_{A,Mg} & \sigma^2_{Mg}  \\
\end{bmatrix}$$




# Measures

Bias: 
$$\frac{1}{n}\sum\hat{\theta}_i - \theta$$,
where $\theta$ is the true value, $\hat{\theta}_i$ is the model estimate from $i$th simulation in a parameter set, and $n$ is the number of simulations.

Precision:
$$1 / \sqrt{ \frac{1}{n}\sum(\hat{\theta}_i - \bar{\hat{\theta}})^2}$$

Relative Precision
$$\bar{\hat{\theta}} / \sqrt{ \frac{1}{n}\sum(\hat{\theta}_i - \bar{\hat{\theta}})^2}$$, where $\bar{\hat{\theta}}$

Mean absolute Error
$$\frac{1}{n}\sum|\hat{\theta}_i - \theta|$$



# Covariance models
Only the models specifying a covariance had any problems running. These models gave a error in `r round(mean(is.na(mod5$Va_est))*100,2)`% of models. This was not equally distributed across scenarios; scenarios with 0 Va often did did not converge (15-25%), compared to <5% in most other scenarios.

```{r, echo=FALSE, fig.width=10,fig.height=10}

order_cov <- expand.grid(fec=c("lF"),ms=c("fhs"),imm=c("mI","nI","bI","fI"),size=c("small","medium"))
order_cov2<-apply(order_cov,1,function(x) paste(x[c(2,1,3,4)],collapse="_"))
# table(is.na(mod5$Va_est),mod5$scenario)[2,]/colSums(table(is.na(mod5$Va_est),mod5$scenario))


par(mfrow=c(2,1), mar=c(5,5,1,1))
barplot(table(is.na(mod5$Va_est),mod5$scenario), xlab="Scenario")
barplot(table(is.na(mod5$Va_est),mod5$r)[,order_cov2], xlab="Pedigree", names=substring(order_cov2,8))


```



# Comparing models

```{r, echo=FALSE, fig.width=10,fig.height=10}

pchs <- c(21:24)
cols <- scales::alpha(palette.colors()[1:4],0.5)

plot_va <- subset(va, r %in% ped_names_reduced[grep("bI",ped_names_reduced)])
{
	par(mfrow=c(4,1),mar=c(4,5,1,1))
beeswarm::beeswarm(Va_bias~ order, plot_va,pch=pchs, cex=1, col=cols,bg=cols,method = "compactswarm",corral="wrap", xlab='Model',ylab="Bias in Va", label=c(1:4,1:4))#, 
abline(h=0)
beeswarm::beeswarm(Va_precision~ order, plot_va,pch=pchs, cex=1, col=cols,bg=cols,method = "compactswarm",corral="wrap", xlab='Model',ylab="Precision Va", label=c(1:4,1:4))#, 
beeswarm::beeswarm(Va_rel_prec~ order, plot_va,pch=pchs, cex=1, col=cols,bg=cols,method = "compactswarm",corral="wrap", xlab='Model',ylab="Realtive precision Va", label=c(1:4,1:4))#, 
beeswarm::beeswarm(Va_abs_bias~ order, plot_va,pch=pchs, cex=1, col=cols,bg=cols,method = "compactswarm",corral="wrap", xlab='Model',ylab="Absolute Error Va", label=c(1:4,1:4))#, label=order)
}


```


```{r, echo=FALSE,fig.width=10}

plot_va <- subset(va, r %in% ped_names_reduced[grep("bI_small",ped_names_reduced)])

	par(mfrow=c(1,1),mar=c(4,5,1,1))

s_col <- scales::alpha(palette.colors()[1:4],0.5)[plot_va$model]
plot(Va_abs_bias~ model, plot_va,pch=pchs, cex=1, col=s_col, bg=s_col, ylab="Mean Absolute Error in Va", las=2)#, 
for(i in 1:nrow(scenarios)){
	for(j in 1:length(ped_names_reduced)){
	lines(Va_abs_bias~order,subset(va,r==ped_names_reduced[j] & scenario==i), col=scales::alpha(1,0.2))}}
```


```{r, echo=FALSE,fig.width=10}
{
	breaks=seq(-0.2,0.2,0.01)
par(mfrow=c(1,2))
par(mar=c(4,4,1,1))
## mod 2 better than mod 1

hist(subset(va, model==1)$Va_abs_bias-subset(va, model==2)$Va_abs_bias, breaks=seq(-0.5,0.5,0.02))
hist(subset(va, model==1)$Va_abs_bias-subset(va, model==4)$Va_abs_bias, breaks=seq(-0.5,0.5,0.02))

# hist(subset(va, model==1 & scenario%in%c(7:10))$Va_abs_bias-subset(va, model==2& scenario%in%c(7:10))$Va_abs_bias, breaks=seq(-0.5,0.5,0.02), add=TRUE, col="blue")

## mod 4 better than mod 3
hist(subset(va, model==2)$Va_abs_bias-subset(va, model==4)$Va_abs_bias, breaks=breaks, main ="MI model MAE - MGE model MAE", xlab="Difference")
hist(subset(va, model==2 & scenario%in%c(3,7:12))$Va_abs_bias-subset(va, model==4& scenario%in%c(3,7:12))$Va_abs_bias, breaks=breaks, add=TRUE, col="red")
hist(subset(va, model==2 & scenario%in%c(7:8))$Va_abs_bias-subset(va, model==4& scenario%in%c(7:8))$Va_abs_bias, breaks=breaks, add=TRUE, col="red")
hist(subset(va, model==2 & scenario%in%c(9:10))$Va_abs_bias-subset(va, model==4& scenario%in%c(9:10))$Va_abs_bias, breaks=breaks, add=TRUE, col="orange")



hist(subset(va, model==2 & scenario%in%c(3,11,12))$Va_abs_bias-subset(va, model==4& scenario%in%c(3,11,12))$Va_abs_bias, breaks=breaks, add=TRUE, col="blue")
legend("topleft",legend=c("Cov","no Vmg"), fill=c("red","blue"))


## mod 5 better than mod 4
hist(subset(va, model==4)$Va_abs_bias-subset(va, model==5)$Va_abs_bias, breaks=breaks, main ="COV model MAE - MGE model MAE", xlab="Difference")

hist(subset(va, model==4 & scenario%in%c(7:10))$Va_abs_bias-subset(va, model==5& scenario%in%c(7:10))$Va_abs_bias, breaks=breaks, add=TRUE, col="yellow")

hist(subset(va, model==4 & scenario%in%c(1:4))$Va_abs_bias-subset(va, model==5& scenario%in%c(1:4))$Va_abs_bias, breaks=breaks, add=TRUE, col="orange")
legend("topleft",legend=c("Cov","no Va"), fill=c("yellow","orange"))

hist(subset(va, model==4 & scenario%in%c(5,6,11,12))$Va_abs_bias-subset(va, model==5& scenario%in%c(5,6,11,12))$Va_abs_bias, breaks=breaks,  col="orange")


}

```



# Are the differences in mod 4 and mod 5 due to model convergence

```{r}

na_mod5<-which(is.na(mod5$Va_est))
hist(mod4$Va_est[na_mod5])

mod4$na_mod5 <- is.na(mod5$Va_est)

mod4_1<-subset(mod4, scenario==1)

par(mfrow=c(2,1))
hist(mod4_1$Va_est[mod4_1$na_mod5], xlim=c(0,1),breaks=seq(0,1,0.025))
hist(mod4_1$Va_est[!mod4_1$na_mod5], xlim=c(0,1),breaks=seq(0,1,0.025))

tapply()

mean(mod4_1$Va_est[mod4_1$na_mod5])
mean(mod4_1$Va_est[!mod4_1$na_mod5])
mean(mod4_1$Va_est)

mod5$Va_bias <- mod5$Va_est - mod5$Va_sim
mod4$Va_bias <- mod4$Va_est - mod4$Va_sim

va5<- aggregate(Va_est ~ scenario+r, mod5,mean)
va4<- aggregate(Va_est ~ scenario+r, mod4[!is.na(mod5$Va_est),],mean)


va4_MAE_with <- aggregate(Va_bias ~ scenario+r, mod4, function(x) mean(abs(x)))$Va_bias
va4_MAE_without <- aggregate(Va_bias ~ scenario+r, mod4[!is.na(mod5$Va_est),], function(x) mean(abs(x)))$Va_bias
hist(va4_MAE_with-va4_MAE_without)

va5_MAE <- aggregate(Va_bias ~ scenario+r, mod5, function(x) mean(abs(x)))$Va_bias
hist(va4_MAE_with)
hist(va4_MAE_without)

hist(va4_MAE_with - va5_MAE, breaks=breaks)
hist(va4_MAE_without - va5_MAE, breaks=breaks)



```
